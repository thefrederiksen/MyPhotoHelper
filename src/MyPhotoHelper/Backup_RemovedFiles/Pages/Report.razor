@page "/report"
@using FaceVault.Services
@using FaceVault.Models

<PageTitle>Library Report - FaceVault</PageTitle>

<FaceVault.Components.ErrorBoundary PageName="Report" OnRetry="@RefreshReport">

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6">
                        <span class="oi oi-bar-chart me-3" aria-hidden="true"></span>
                        üìä Library Report
                    </h1>
                    <p class="text-muted">Comprehensive statistics about your photo collection</p>
                </div>
                <div>
                    <button class="btn btn-primary" @onclick="RefreshReport" disabled="@isLoading">
                        <span class="oi oi-reload me-2" aria-hidden="true"></span>
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Refresh Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Generating report...</span>
            </div>
            <div class="mt-3">Analyzing your photo library...</div>
        </div>
    }
    else if (report != null)
    {
        <!-- Generation Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <span class="oi oi-info" aria-hidden="true"></span>
                    Report generated on @report.GeneratedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")
                </div>
            </div>
        </div>

        <!-- Overall Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <span class="oi oi-image display-4 text-primary mb-3" aria-hidden="true"></span>
                        <h5 class="card-title">Total Images</h5>
                        <h2 class="text-primary">@report.Overall.TotalImages.ToString("N0")</h2>
                        <small class="text-muted">
                            üì∏ @report.Overall.TotalPhotos.ToString("N0") Photos<br>
                            üñ•Ô∏è @report.Overall.TotalScreenshots.ToString("N0") Screenshots
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <span class="oi oi-layers display-4 text-warning mb-3" aria-hidden="true"></span>
                        <h5 class="card-title">Duplicates</h5>
                        <h2 class="text-warning">@report.Overall.TotalDuplicates.ToString("N0")</h2>
                        <small class="text-muted">
                            @report.Overall.UniqueImages.ToString("N0") Unique Images
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <span class="oi oi-hard-drive display-4 text-success mb-3" aria-hidden="true"></span>
                        <h5 class="card-title">Storage Used</h5>
                        <h2 class="text-success">@report.Storage.TotalSizeFormatted</h2>
                        <small class="text-muted">
                            Avg: @report.Storage.AverageFileSizeMB.ToString("F1") MB per file
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <span class="oi oi-calendar display-4 text-info mb-3" aria-hidden="true"></span>
                        <h5 class="card-title">Time Span</h5>
                        <h2 class="text-info">@((int)report.Overall.LibrarySpan.TotalDays / 365) Years</h2>
                        <small class="text-muted">
                            @report.Overall.OldestImage?.ToString("yyyy") - @report.Overall.NewestImage?.ToString("yyyy")
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images by Year -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="oi oi-calendar me-2" aria-hidden="true"></span>
                            üìÖ Images by Year
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Total Images</th>
                                        <th>Photos</th>
                                        <th>Screenshots</th>
                                        <th>Storage Size</th>
                                        <th>Progress</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var year in report.ImagesByYear)
                                    {
                                        var maxCount = report.ImagesByYear.Max(y => y.Count);
                                        var percentage = maxCount > 0 ? (double)year.Count / maxCount * 100 : 0;
                                        
                                        <tr>
                                            <td><strong>@year.Year</strong></td>
                                            <td>@year.Count.ToString("N0")</td>
                                            <td>@year.Photos.ToString("N0")</td>
                                            <td>@year.Screenshots.ToString("N0")</td>
                                            <td>@year.TotalSizeFormatted</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: @percentage.ToString("F1")%"
                                                         aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                                        @percentage.ToString("F0")%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Year Monthly Breakdown -->
        @if (report.CurrentYearByMonth.Any())
        {
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="oi oi-calendar me-2" aria-hidden="true"></span>
                                üìä @DateTime.Now.Year Monthly Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                @foreach (var month in report.CurrentYearByMonth)
                                {
                                    <div class="col-md-2 mb-3">
                                        <div class="card text-center">
                                            <div class="card-body p-2">
                                                <h6>@month.MonthName</h6>
                                                <h4 class="text-primary">@month.Count</h4>
                                                <small class="text-muted">
                                                    üì∏@month.Photos üñ•Ô∏è@month.Screenshots
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Duplicates Section -->
        @if (report.Duplicates.TotalGroups > 0)
        {
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="oi oi-layers me-2 text-warning" aria-hidden="true"></span>
                                üîÑ Duplicate Analysis
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="alert alert-warning text-center">
                                        <h4>@report.Duplicates.TotalGroups</h4>
                                        <small>Duplicate Groups</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-danger text-center">
                                        <h4>@report.Duplicates.TotalDuplicates</h4>
                                        <small>Duplicate Files</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-info text-center">
                                        <h4>@report.Duplicates.WastedSizeFormatted</h4>
                                        <small>Wasted Space</small>
                                    </div>
                                </div>
                            </div>

                            @if (report.Duplicates.SampleGroups.Any())
                            {
                                <h6>Sample Duplicate Groups:</h6>
                                @foreach (var group in report.Duplicates.SampleGroups)
                                {
                                    <div class="card mb-3 border-warning">
                                        <div class="card-header bg-warning bg-opacity-10">
                                            <strong>@group.Count identical files</strong> - Wasting @group.WastedSpaceFormatted
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                @foreach (var image in group.Images.Take(3))
                                                {
                                                    <FaceVault.Components.ImageViewer Photo="image" ShowTime="false" />
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                                
                                <div class="text-center">
                                    <a href="/duplicates" class="btn btn-warning">
                                        <span class="oi oi-trash me-2" aria-hidden="true"></span>
                                        Clean Up All Duplicates
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Screenshots Section -->
        @if (report.Screenshots.TotalScreenshots > 0)
        {
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="oi oi-monitor me-2 text-info" aria-hidden="true"></span>
                                üñ•Ô∏è Screenshot Analysis
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="alert alert-info text-center">
                                        <h4>@report.Screenshots.TotalScreenshots</h4>
                                        <small>Screenshots</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-primary text-center">
                                        <h4>@report.Screenshots.PercentageOfLibrary.ToString("F1")%</h4>
                                        <small>Of Total Library</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-secondary text-center">
                                        <h4>@report.Screenshots.TotalSizeFormatted</h4>
                                        <small>Storage Used</small>
                                    </div>
                                </div>
                            </div>

                            @if (report.Screenshots.SampleScreenshots.Any())
                            {
                                <h6>Sample Screenshots:</h6>
                                <div class="row">
                                    @foreach (var screenshot in report.Screenshots.SampleScreenshots)
                                    {
                                        <FaceVault.Components.ImageViewer Photo="screenshot" ShowTime="false" />
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- File Formats -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="oi oi-document me-2" aria-hidden="true"></span>
                            üìÅ File Formats
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var format in report.FileFormats.Take(10))
                        {
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span><strong>@format.Extension.ToUpper()</strong></span>
                                    <span>@format.Count (@format.Percentage.ToString("F1")%)</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar" style="width: @format.Percentage.ToString("F1")%"></div>
                                </div>
                                <small class="text-muted">@format.TotalSizeFormatted</small>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="oi oi-hard-drive me-2" aria-hidden="true"></span>
                            üíæ Storage Breakdown
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>üì∏ Photos</span>
                                <span>@report.Storage.PhotoSizeFormatted</span>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: @(report.Storage.TotalBytes > 0 ? (double)report.Storage.PhotoBytes / report.Storage.TotalBytes * 100 : 0)%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>üñ•Ô∏è Screenshots</span>
                                <span>@report.Storage.ScreenshotSizeFormatted</span>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: @(report.Storage.TotalBytes > 0 ? (double)report.Storage.ScreenshotBytes / report.Storage.TotalBytes * 100 : 0)%"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>üì± HEIC Images</span>
                                <span>@report.Storage.HeicSizeFormatted</span>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: @(report.Storage.TotalBytes > 0 ? (double)report.Storage.HeicBytes / report.Storage.TotalBytes * 100 : 0)%"></div>
                            </div>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total Storage</strong>
                            <strong>@report.Storage.TotalSizeFormatted</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Largest Files -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="oi oi-clock me-2" aria-hidden="true"></span>
                            üïê Recent Activity
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <h4 class="text-primary">@report.Recent.ImagesLast7Days</h4>
                                <small>Last 7 days</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-info">@report.Recent.ImagesLast30Days</h4>
                                <small>Last 30 days</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-secondary">@report.Recent.ImagesLast90Days</h4>
                                <small>Last 90 days</small>
                            </div>
                        </div>

                        @if (report.Recent.RecentImages.Any())
                        {
                            <h6>Recently Added:</h6>
                            @foreach (var image in report.Recent.RecentImages)
                            {
                                <div class="d-flex align-items-center mb-2">
                                    <div class="flex-shrink-0 me-2">
                                        <FaceVault.Components.ImageThumbnail Photo="image" Size="40" CssClass="rounded" />
                                    </div>
                                    <div class="flex-grow-1">
                                        <small>
                                            <strong>@image.FileName</strong><br>
                                            <span class="text-muted">@image.DateCreated.ToString("MMM dd, h:mm tt")</span>
                                        </small>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="oi oi-resize-height me-2" aria-hidden="true"></span>
                            üìè Largest Files
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var image in report.LargestFiles.Take(8))
                        {
                            <div class="d-flex align-items-center mb-2">
                                <div class="flex-shrink-0 me-2">
                                    <FaceVault.Components.ImageThumbnail Photo="image" Size="40" CssClass="rounded" />
                                </div>
                                <div class="flex-grow-1">
                                    <small>
                                        <strong>@image.FileName</strong><br>
                                        <span class="text-muted">@image.SizeFormatted</span>
                                    </small>
                                </div>
                                <div class="flex-shrink-0">
                                    <a href="#" @onclick="() => OpenImage(image.FilePath)" 
                                       @onclick:preventDefault="true" class="btn btn-outline-primary btn-sm">
                                        <span class="oi oi-eye" aria-hidden="true"></span>
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <span class="oi oi-warning" aria-hidden="true"></span>
            Unable to generate report. Please try refreshing.
        </div>
    }
</div>

</FaceVault.Components.ErrorBoundary>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .progress {
        border-radius: 10px;
    }
    
    .progress-bar {
        border-radius: 10px;
    }
</style>