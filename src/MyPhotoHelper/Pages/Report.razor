@page "/report"
@using MyPhotoHelper.Data
@using MyPhotoHelper.Models
@using MyPhotoHelper.Services
@using MyPhotoHelper.Components.Shared
@using Microsoft.EntityFrameworkCore
@inject MyPhotoHelperDbContext DbContext
@inject IPathService PathService
@inject NavigationManager Navigation
@inject ILogger<Report> Logger
@inject IImageDetailsService ImageDetailsService
@inject IScreenshotAnalysisService ScreenshotAnalysisService
@inject IFastImageCategorizationService FastImageCategorizationService
@inject IImageDisplayService ImageDisplayService

<PageTitle>Library Report - MyPhotoHelper</PageTitle>

<div class="container-fluid">
    <h1 class="display-4">üìä Library Report</h1>
    <p class="lead">Overview of your photo collection</p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
            <span class="oi oi-x" aria-hidden="true"></span> <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border spinner-border-xl text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading report data...</span>
            </div>
            <h4>Generating Your Report</h4>
            <p class="text-muted">
                <span class="d-block">Loading photo statistics...</span>
                <span class="d-block">Analyzing your library...</span>
                <span class="d-block">Finding duplicate photos...</span>
            </p>
        </div>
    }
    else
    {
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-lg-2 col-md-4 mb-3">
                <div class="card text-center h-100 stat-card">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h6 class="card-title text-primary mb-3">Total Photos</h6>
                        <h2 class="display-6 mb-0">@totalImages.ToString("N0")</h2>
                        <small class="text-muted mt-2">In your library</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 mb-3">
                <div class="card text-center h-100 stat-card">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h6 class="card-title text-warning mb-3">Screenshots</h6>
                        <h2 class="display-6 mb-0">@screenshotCount.ToString("N0")</h2>
                        <small class="text-muted mt-2">Found</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 mb-3">
                <div class="card text-center h-100 stat-card">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h6 class="card-title text-success mb-3">Analyzed</h6>
                        <h2 class="display-6 mb-0">@analyzedImages.ToString("N0")</h2>
                        <small class="text-muted mt-2">Photos processed</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 mb-3">
                <div class="card text-center h-100 stat-card">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h6 class="card-title text-danger mb-3">Duplicates</h6>
                        <h2 class="display-6 mb-0">@duplicateCount.ToString("N0")</h2>
                        <small class="text-muted mt-2">Files found</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 mb-3">
                <div class="card text-center h-100 stat-card">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h6 class="card-title text-info mb-3">Storage Used</h6>
                        <h2 class="display-6 mb-0">@totalSizeStr</h2>
                        <small class="text-muted mt-2">Total size</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 mb-3">
                <div class="card text-center h-100 stat-card">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h6 class="card-title text-success mb-3">Real Photos</h6>
                        <h2 class="display-6 mb-0">@realPhotoCount.ToString("N0")</h2>
                        <small class="text-muted mt-2">Personal photos</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Categories -->
        @if (categoryStats.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="oi oi-tag" aria-hidden="true"></span> Photo Categories</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var category in categoryStats.OrderByDescending(c => c.Count))
                        {
                            <div class="col-md-4 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">@(category.Category == "photo" ? "üì∑ Photos" : category.Category == "screenshot" ? "üñ•Ô∏è Screenshots" : "‚ùì Other")</h6>
                                    <span class="badge bg-primary">@category.Count</span>
                                </div>
                                <div class="progress progress-thick mb-2">
                                    @{
                                        var percent = totalImages > 0 ? (double)category.Count / totalImages * 100 : 0;
                                        var progressColor = category.Category == "photo" ? "bg-success" : category.Category == "screenshot" ? "bg-warning" : "bg-secondary";
                                        // Ensure minimum visible width for very small percentages
                                        var displayWidth = Math.Max(percent, percent > 0 ? 8 : 0);
                                    }
                                    <div class="progress-bar @progressColor" role="progressbar" style="width: @displayWidth%" title="@percent.ToString("F1")% (@category.Count photos)">
                                        @if (displayWidth > 15 || percent > 3)
                                        {
                                            <span>@percent.ToString("F0")%</span>
                                        }
                                    </div>
                                </div>
                                <small class="text-muted">@percent.ToString("F1")% (@category.Count photos)</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }


        <!-- Screenshot Detection -->
        @if (categorizationStats != null && screenshotCount > 0)
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="oi oi-monitor" aria-hidden="true"></span> Screenshot Detection</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-warning">@categorizationStats.TotalScreenshots.ToString("N0")</h3>
                                <p class="text-muted mb-0">Screenshots found in your library</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="progress progress-thick mt-3">
                                @{
                                    var screenshotPercent = totalImages > 0 ? (double)screenshotCount / totalImages * 100 : 0;
                                }
                                <div class="progress-bar bg-warning" role="progressbar" style="width: @screenshotPercent%">
                                    <span>Screenshots: @screenshotPercent.ToString("F0")%</span>
                                </div>
                                <div class="progress-bar bg-success" role="progressbar" style="width: @(100 - screenshotPercent)%">
                                    <span>Real Photos: @((100 - screenshotPercent).ToString("F0"))%</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-2">
                                <span>üñ•Ô∏è Screenshots</span>
                                <span>üì∑ Real Photos</span>
                            </div>
                        </div>
                    </div>
                    
                    @if (screenshotSamples.Any())
                    {
                        <hr>
                        <h6>Recent Screenshots</h6>
                        <div class="row">
                            @foreach (var sample in screenshotSamples.Take(6))
                            {
                                <div class="col-md-2 mb-2">
                                    <div class="card shadow-sm">
                                        @if (thumbnailDataUris.ContainsKey(sample.ImageId))
                                        {
                                            <img src="@thumbnailDataUris[sample.ImageId]" 
                                                 class="card-img-top" 
                                                 alt="@sample.FileName"
                                                 style="height: 100px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 100px;">
                                                <i class="oi oi-image text-muted"></i>
                                            </div>
                                        }
                                        <div class="card-body p-2">
                                            <small class="text-muted d-block text-truncate" title="@sample.FileName">
                                                @sample.FileName
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }


        <!-- Recently Analyzed Photos -->
        @if (aiSamples.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="oi oi-image" aria-hidden="true"></span> Recently Analyzed Photos</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var sample in aiSamples.Take(6))
                        {
                            <div class="col-md-4 mb-3">
                                <div class="card shadow-sm h-100">
                                    @if (thumbnailDataUris.ContainsKey(sample.ImageId))
                                    {
                                        <img src="@thumbnailDataUris[sample.ImageId]" 
                                             class="card-img-top" 
                                             alt="@sample.FileName"
                                             style="height: 200px; object-fit: cover; cursor: pointer;"
                                             @onclick="() => ShowImageDetails(sample.ImageId)">
                                    }
                                    else
                                    {
                                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
                                            <i class="oi oi-image text-muted"></i>
                                        </div>
                                    }
                                    <div class="card-body">
                                        <h6 class="card-title text-truncate" title="@sample.FileName">
                                            <span class="oi oi-file" aria-hidden="true"></span> @sample.FileName
                                        </h6>
                                        @if (!string.IsNullOrEmpty(sample.Description))
                                        {
                                            <p class="small text-muted">@(sample.Description.Length > 80 ? sample.Description.Substring(0, 80) + "..." : sample.Description)</p>
                                        }
                                        <div class="mt-2">
                                            <span class="badge bg-info">@(sample.Category == "photo" ? "üì∑ Photo" : sample.Category == "screenshot" ? "üñ•Ô∏è Screenshot" : "‚ùì Other")</span>
                                            @if (sample.AnalyzedAt.HasValue)
                                            {
                                                <small class="text-muted d-block mt-1">Analyzed @sample.AnalyzedAt.Value.ToString("MMM dd")</small>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (analyzedImages == 0)
        {
            <div class="alert alert-info" role="alert">
                <p class="mb-0"><span class="oi oi-info" aria-hidden="true"></span> No photos have been analyzed yet. Analysis helps categorize your photos automatically.</p>
            </div>
        }

        <!-- Duplicate Analysis -->
        @if (duplicateGroups.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <span class="oi oi-layers me-2 text-warning" aria-hidden="true"></span>
                        üîÑ Duplicate Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="alert alert-warning text-center">
                                <h4>@duplicateGroups.Count</h4>
                                <small>Duplicate Groups</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-danger text-center">
                                <h4>@duplicateCount</h4>
                                <small>Duplicate Files</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-info text-center">
                                <h4>@FormatFileSize(duplicateGroups.Sum(g => g.FileSize * (g.Files.Count - 1)))</h4>
                                <small>Wasted Space</small>
                            </div>
                        </div>
                    </div>

                    <h6>Sample Duplicate Groups:</h6>
                    @{
                        int groupIndex = 0;
                    }
                    @foreach (var group in duplicateGroups.Take(5))
                    {
                        <div class="card mb-3 border-warning">
                            <div class="card-header bg-warning bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@group.Files.Count identical files</strong> - 
                                        Wasting @FormatFileSize(group.FileSize * (group.Files.Count - 1))
                                    </div>
                                    <small class="text-muted">Hash: @group.Hash.Substring(0, 12)...</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    @foreach (var image in group.Files.Take(3))
                                    {
                                        <div class="col-4">
                                            <div class="position-relative">
                                                <ImageViewer Photo="image" ContainerClass="w-100" ShowTime="false" />
                                                <div class="position-absolute top-0 start-0 m-1" style="z-index: 10;">
                                                    <span class="badge bg-dark bg-opacity-75">@FormatFileSize(image.FileSizeBytes)</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="border-top pt-2">
                                    <h6 class="mb-2">File Locations:</h6>
                                    @foreach (var file in group.Files)
                                    {
                                        <div class="mb-1 small">
                                            <span class="oi oi-folder me-1" aria-hidden="true"></span>
                                            <strong>@(file.ScanDirectory?.DirectoryPath ?? "Unknown"):</strong>
                                            @file.RelativePath
                                            <span class="text-muted ms-2">(@file.DateCreated.ToString("yyyy-MM-dd"))</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        groupIndex++;
                    }
                    
                    @if (duplicateGroups.Count > 5)
                    {
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" @onclick="ShowAllDuplicates">
                                <span class="oi oi-layers me-2" aria-hidden="true"></span>
                                View All @duplicateGroups.Count Duplicate Groups
                            </button>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Scan Directories -->
        @if (scanDirectories.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <span class="oi oi-folder me-2" aria-hidden="true"></span>
                        üìÅ Scan Directories
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var dir in scanDirectories)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <span class="oi oi-folder-open me-2" aria-hidden="true"></span>
                                            @Path.GetFileName(dir.DirectoryPath)
                                        </h6>
                                        <p class="small text-muted mb-2">@dir.DirectoryPath</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-primary">@dir.ImageCount images</span>
                                            <small class="text-muted">Added @dir.DateCreated.ToString("MMM dd, yyyy")</small>
                                        </div>
                                        @if (dir.ImageCount > 0)
                                        {
                                            <div class="progress mt-2" style="height: 6px;">
                                                <div class="progress-bar" 
                                                     style="width: @(totalImages > 0 ? (double)dir.ImageCount / totalImages * 100 : 0)%"
                                                     title="@((totalImages > 0 ? (double)dir.ImageCount / totalImages * 100 : 0).ToString("F1"))% of total library"></div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Photo Locations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="oi oi-map-marker me-2" aria-hidden="true"></span>
                    Photo Locations
                </h5>
            </div>
            <div class="card-body">
                @if (gpsEnabledImages == 0)
                {
                    <div class="text-center py-3">
                        <i class="oi oi-map-marker text-muted" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 text-muted">No Location Data Found</h6>
                        <p class="text-muted mb-0">Photos taken with smartphones usually include location information.</p>
                    </div>
                }
                else
                {
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success">@gpsEnabledImages.ToString("N0")</h3>
                                <p class="text-muted mb-0">Photos with locations</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-info">@uniqueLocations</h3>
                                <p class="text-muted mb-0">Different places</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="progress progress-thick mt-3">
                                <div class="progress-bar bg-success" role="progressbar" style="width: @gpsPercentage%">
                                    <span>@gpsPercentage.ToString("F0")%</span>
                                </div>
                            </div>
                            <small class="text-muted">of photos have locations</small>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- File Type Distribution -->
        @if (fileTypeStats.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="oi oi-pie-chart" aria-hidden="true"></span> File Type Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var fileType in fileTypeStats.OrderByDescending(f => f.Count))
                        {
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <h6>@fileType.Extension.ToUpper()</h6>
                                    <h4 class="text-primary">@fileType.Count.ToString("N0")</h4>
                                    <small class="text-muted">@fileType.Percentage.ToString("F1")%</small>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mb-4">
            <button class="btn btn-outline-secondary" @onclick="GoBack">
                <span class="oi oi-arrow-left" aria-hidden="true"></span> Back to Home
            </button>
            <button class="btn btn-primary" @onclick="RefreshReport" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                <span class="oi oi-reload" aria-hidden="true"></span> Refresh Report
            </button>
        </div>
    }
</div>

<style>
    /* Summary stat cards */
    .stat-card {
        min-height: 160px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
    }
    
    .stat-card .card-body {
        min-height: 160px;
        padding: 1.5rem;
    }
    
    .stat-card .display-6 {
        font-size: 2.2rem;
        font-weight: 300;
        line-height: 1.2;
    }
    
    .stat-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem !important;
    }
    
    /* Progress bars */
    .progress-thick {
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
        background-color: #e9ecef;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .progress-thick .progress-bar {
        font-weight: 600;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    /* Enhanced progress bar colors */
    .progress-bar.bg-success {
        background-color: #28a745 !important;
    }
    
    .progress-bar.bg-warning {
        background-color: #ffc107 !important;
        color: #000;
        text-shadow: none;
    }
    
    .progress-bar.bg-info {
        background-color: #17a2b8 !important;
    }
    
    .progress-bar.bg-primary {
        background-color: #007bff !important;
    }
    
    /* Card improvements */
    .card {
        border: 1px solid #dee2e6;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
</style>

@code {
    private bool isLoading = true;
    private string errorMessage = "";
    
    // Summary stats
    private int totalImages = 0;
    private int analyzedImages = 0;
    private int percentAnalyzed = 0;
    private int duplicateCount = 0;
    private long totalSize = 0;
    private string totalSizeStr = "0 B";
    
    // Screenshot stats
    private int screenshotCount = 0;
    private int screenshotPercentage = 0;
    private int realPhotoCount = 0;
    private int realPhotoPercentage = 0;
    private ImageCategorizationResults? categorizationStats = null;
    private List<tbl_images> screenshotSamples = new();
    private Dictionary<int, string> thumbnailDataUris = new();
    
    // Category statistics
    private List<CategoryStat> categoryStats = new();
    
    // AI samples
    private List<AISample> aiSamples = new();
    private List<AISample> allAiSamples = new();
    private int currentAiPage = 0;
    private int aiSamplesPerPage = 6;
    
    // Duplicate groups
    private List<DuplicateGroup> duplicateGroups = new();
    
    // File type statistics
    private List<FileTypeStat> fileTypeStats = new();
    
    // Scan directories
    private List<ScanDirectoryStat> scanDirectories = new();
    
    // GPS/Location statistics
    private int gpsEnabledImages = 0;
    private int uniqueLocations = 0;
    private double gpsPercentage = 0;
    private List<FileTypeStat> gpsFileTypeStats = new();
    private List<GpsSampleImage> gpsSampleImages = new();

    private class CategoryStat
    {
        public string Category { get; set; } = "";
        public int Count { get; set; }
    }

    private class AISample
    {
        public int ImageId { get; set; }
        public string FileName { get; set; } = "";
        public string Category { get; set; } = "";
        public string Description { get; set; } = "";
        public string AIModel { get; set; } = "";
        public DateTime? AnalyzedAt { get; set; }
        public string JsonResponse { get; set; } = "";
        public string Keywords { get; set; } = "";
    }

    private class DuplicateGroup
    {
        public string Hash { get; set; } = "";
        public long FileSize { get; set; }
        public List<tbl_images> Files { get; set; } = new();
    }

    private class FileTypeStat
    {
        public string Extension { get; set; } = "";
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    private class ScanDirectoryStat
    {
        public string DirectoryPath { get; set; } = "";
        public int ImageCount { get; set; }
        public DateTime DateCreated { get; set; }
    }

    private class GpsSampleImage
    {
        public int ImageId { get; set; }
        public string FileName { get; set; } = "";
        public string FileExtension { get; set; } = "";
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public DateTime? DateTaken { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // IMMEDIATE FEEDBACK - SHOW LOADING RIGHT NOW!
        isLoading = true;
        errorMessage = "";
        StateHasChanged();
        
        try
        {
            // Ensure UI updates
            await Task.Delay(100);
            
            // Now load the data
            await LoadReportData();
        }
        catch (OperationCanceledException)
        {
            // Page navigation occurred, ignore
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during report initialization");
            errorMessage = $"Failed to load report: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadReportData()
    {
        try
        {
            isLoading = true;
            errorMessage = "";
            StateHasChanged();

            // Load basic statistics
            totalImages = await DbContext.tbl_images.CountAsync(i => i.IsDeleted == 0);
            
            // Load AI analysis statistics
            analyzedImages = await DbContext.tbl_image_analysis.CountAsync();
            percentAnalyzed = totalImages > 0 ? (analyzedImages * 100 / totalImages) : 0;
            
            // Load category statistics
            categoryStats = await DbContext.tbl_image_analysis
                .GroupBy(a => a.ImageCategory ?? "Unknown")
                .Select(g => new CategoryStat 
                { 
                    Category = g.Key, 
                    Count = g.Count() 
                })
                .ToListAsync();
            
            // Load categorization statistics
            categorizationStats = await FastImageCategorizationService.GetCategorizationStatisticsAsync();
            screenshotCount = categorizationStats?.TotalScreenshots ?? 0;
            screenshotPercentage = totalImages > 0 ? (int)Math.Round((double)screenshotCount * 100 / totalImages) : 0;
            realPhotoCount = totalImages - screenshotCount;
            realPhotoPercentage = totalImages > 0 ? (realPhotoCount * 100 / totalImages) : 0;
            
            // Load screenshot samples
            screenshotSamples = await DbContext.tbl_images
                .Join(DbContext.tbl_image_analysis,
                    img => img.ImageId,
                    analysis => analysis.ImageId,
                    (img, analysis) => new { Image = img, Analysis = analysis })
                .Where(x => x.Analysis.ImageCategory == "screenshot" && x.Image.IsDeleted == 0)
                .Select(x => x.Image)
                .Take(12)
                .ToListAsync();
            
            // Generate data URIs for screenshot thumbnails
            foreach (var sample in screenshotSamples)
            {
                var dataUri = await ImageDisplayService.GetThumbnailDataUriAsync(sample.ImageId);
                if (!string.IsNullOrEmpty(dataUri))
                {
                    thumbnailDataUris[sample.ImageId] = dataUri;
                }
            }
            
            // Load ALL AI analysis samples
            allAiSamples = await DbContext.tbl_image_analysis
                .Join(DbContext.tbl_images,
                    analysis => analysis.ImageId,
                    image => image.ImageId,
                    (analysis, image) => new AISample
                    {
                        ImageId = image.ImageId,
                        FileName = image.FileName,
                        Category = analysis.ImageCategory ?? "Unknown",
                        Description = analysis.AIDescription ?? "",
                        AIModel = analysis.AIModelUsed ?? "Unknown",
                        AnalyzedAt = analysis.AIAnalyzedAt,
                        JsonResponse = analysis.AIAnalysisJson ?? "",
                        Keywords = analysis.AIKeywords ?? ""
                    })
                .OrderByDescending(s => s.AnalyzedAt)
                .ToListAsync();
            
            // Set initial page of samples and generate thumbnails
            currentAiPage = 0;
            await UpdateAiSamplesPage();
            
            // Load duplicate statistics with scan directory information
            var duplicates = await DbContext.tbl_images
                .Include(i => i.ScanDirectory)
                .Where(i => i.IsDeleted == 0 && !string.IsNullOrEmpty(i.FileHash))
                .GroupBy(i => i.FileHash)
                .Where(g => g.Count() > 1)
                .Select(g => new DuplicateGroup
                {
                    Hash = g.Key!,
                    FileSize = g.First().FileSizeBytes,
                    Files = g.ToList()
                })
                .ToListAsync();
            
            duplicateGroups = duplicates;
            duplicateCount = duplicates.Sum(g => g.Files.Count - 1); // Don't count the original
            
            // Calculate total size
            totalSize = await DbContext.tbl_images
                .Where(i => i.IsDeleted == 0)
                .SumAsync(i => (long)i.FileSizeBytes);
            totalSizeStr = FormatFileSize(totalSize);
            
            // Load scan directories statistics
            scanDirectories = await DbContext.tbl_scan_directory
                .Select(sd => new ScanDirectoryStat
                {
                    DirectoryPath = sd.DirectoryPath,
                    ImageCount = DbContext.tbl_images.Count(img => img.ScanDirectoryId == sd.ScanDirectoryId && img.IsDeleted == 0),
                    DateCreated = sd.DateCreated
                })
                .OrderBy(sd => sd.DateCreated)
                .ToListAsync();
            
            // Load file type statistics
            var extensions = await DbContext.tbl_images
                .Where(i => i.IsDeleted == 0 && !string.IsNullOrEmpty(i.FileName))
                .Select(i => Path.GetExtension(i.FileName).ToLower())
                .ToListAsync();
            
            fileTypeStats = extensions
                .GroupBy(ext => string.IsNullOrEmpty(ext) ? ".unknown" : ext)
                .Select(g => new FileTypeStat
                {
                    Extension = g.Key,
                    Count = g.Count(),
                    Percentage = totalImages > 0 ? (double)g.Count() / totalImages * 100 : 0
                })
                .OrderByDescending(f => f.Count)
                .ToList();
            
            // Load GPS/Location statistics
            var photosWithGps = await DbContext.tbl_images
                .Where(img => img.FileExists == 1 && img.IsDeleted == 0)
                .Join(DbContext.tbl_image_metadata.Where(m => m.Latitude.HasValue && m.Longitude.HasValue),
                      img => img.ImageId,
                      meta => meta.ImageId,
                      (img, meta) => new { Image = img, Metadata = meta })
                .ToListAsync();

            gpsEnabledImages = photosWithGps.Count;
            gpsPercentage = totalImages > 0 ? (double)gpsEnabledImages / totalImages * 100 : 0;

            // Count unique locations (rounded to ~100m precision)
            uniqueLocations = photosWithGps
                .GroupBy(x => new 
                { 
                    Lat = Math.Round(x.Metadata.Latitude!.Value, 3),
                    Lon = Math.Round(x.Metadata.Longitude!.Value, 3)
                })
                .Count();

            // GPS file type statistics
            if (photosWithGps.Any())
            {
                var gpsExtensions = photosWithGps
                    .Select(x => Path.GetExtension(x.Image.FileName).ToLower())
                    .ToList();

                gpsFileTypeStats = gpsExtensions
                    .GroupBy(ext => string.IsNullOrEmpty(ext) ? ".unknown" : ext)
                    .Select(g => new FileTypeStat
                    {
                        Extension = g.Key,
                        Count = g.Count(),
                        Percentage = gpsEnabledImages > 0 ? (double)g.Count() / gpsEnabledImages * 100 : 0
                    })
                    .OrderByDescending(f => f.Count)
                    .ToList();

                // Load sample GPS images - try to get different file types
                var distinctExtensions = gpsFileTypeStats.Take(4).Select(f => f.Extension).ToList();
                gpsSampleImages = new List<GpsSampleImage>();

                foreach (var extension in distinctExtensions)
                {
                    var sample = photosWithGps
                        .Where(x => Path.GetExtension(x.Image.FileName).ToLower() == extension)
                        .OrderByDescending(x => x.Metadata.DateTaken ?? x.Image.DateModified)
                        .Select(x => new GpsSampleImage
                        {
                            ImageId = x.Image.ImageId,
                            FileName = x.Image.FileName,
                            FileExtension = Path.GetExtension(x.Image.FileName),
                            Latitude = x.Metadata.Latitude!.Value,
                            Longitude = x.Metadata.Longitude!.Value,
                            DateTaken = x.Metadata.DateTaken
                        })
                        .FirstOrDefault();

                    if (sample != null)
                    {
                        gpsSampleImages.Add(sample);
                    }
                }

                // If we have fewer than 6 samples, fill with any remaining photos
                if (gpsSampleImages.Count < 6)
                {
                    var additionalSamples = photosWithGps
                        .Where(x => !gpsSampleImages.Any(s => s.ImageId == x.Image.ImageId))
                        .OrderByDescending(x => x.Metadata.DateTaken ?? x.Image.DateModified)
                        .Take(6 - gpsSampleImages.Count)
                        .Select(x => new GpsSampleImage
                        {
                            ImageId = x.Image.ImageId,
                            FileName = x.Image.FileName,
                            FileExtension = Path.GetExtension(x.Image.FileName),
                            Latitude = x.Metadata.Latitude!.Value,
                            Longitude = x.Metadata.Longitude!.Value,
                            DateTaken = x.Metadata.DateTaken
                        })
                        .ToList();

                    gpsSampleImages.AddRange(additionalSamples);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading report data");
            errorMessage = $"Failed to load report data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshReport()
    {
        // IMMEDIATE FEEDBACK!
        isLoading = true;
        errorMessage = "";
        StateHasChanged();
        
        await Task.Delay(100);
        await LoadReportData();
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void ShowAllDuplicates()
    {
        // TODO: Navigate to dedicated duplicates page
        // For now, show an alert
        // Navigation.NavigateTo("/duplicates");
    }

    private async Task UpdateAiSamplesPage()
    {
        aiSamples = allAiSamples
            .Skip(currentAiPage * aiSamplesPerPage)
            .Take(aiSamplesPerPage)
            .ToList();
            
        // Generate data URIs for new page of AI samples
        foreach (var sample in aiSamples)
        {
            if (!thumbnailDataUris.ContainsKey(sample.ImageId))
            {
                var dataUri = await ImageDisplayService.GetThumbnailDataUriAsync(sample.ImageId);
                if (!string.IsNullOrEmpty(dataUri))
                {
                    thumbnailDataUris[sample.ImageId] = dataUri;
                }
            }
        }
    }

    private async Task NextAiPage()
    {
        if ((currentAiPage + 1) * aiSamplesPerPage < allAiSamples.Count)
        {
            currentAiPage++;
            await UpdateAiSamplesPage();
            StateHasChanged();
        }
    }

    private async Task PreviousAiPage()
    {
        if (currentAiPage > 0)
        {
            currentAiPage--;
            await UpdateAiSamplesPage();
            StateHasChanged();
        }
    }

    private void ShowImageDetails(int imageId)
    {
        ImageDetailsService.ShowImageDetails(imageId);
    }

    private string GetFormattedPercentage(int count, int total)
    {
        if (total == 0) return "0%";
        
        double percentage = (double)count * 100 / total;
        
        if (percentage < 0.1 && count > 0)
        {
            // For very small percentages, show more decimal places
            return $"{percentage:F2}%";
        }
        else if (percentage < 1.0 && count > 0)
        {
            // For small percentages, show one decimal place
            return $"{percentage:F1}%";
        }
        else
        {
            // For larger percentages, show whole numbers
            return $"{percentage:F0}%";
        }
    }
}