@page "/report"
@using MyPhotoHelper.Data
@using MyPhotoHelper.Models
@using MyPhotoHelper.Services
@using MyPhotoHelper.Components.Shared
@using Microsoft.EntityFrameworkCore
@inject MyPhotoHelperDbContext DbContext
@inject IPathService PathService
@inject NavigationManager Navigation
@inject ILogger<Report> Logger
@inject IImageDetailsService ImageDetailsService
@inject IScreenshotAnalysisService ScreenshotAnalysisService
@inject IFastImageCategorizationService FastImageCategorizationService
@inject IImageDisplayService ImageDisplayService

<PageTitle>Library Report - MyPhotoHelper</PageTitle>

<div class="w-full">
    <h1 class="text-5xl font-light">üìä Library Report</h1>
    <p class="text-lg">Overview of your photo collection</p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-3" role="alert">
            <span class="oi oi-x" aria-hidden="true"></span> <strong>Error:</strong> @errorMessage
            <button type="button" class="float-right text-red-700 hover:text-red-900" @onclick="() => errorMessage = string.Empty">√ó</button>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-3" role="status">
                <span class="sr-only">Loading report data...</span>
            </div>
            <h4>Generating Your Report</h4>
            <p class="text-gray-500">
                <span class="block">Loading photo statistics...</span>
                <span class="block">Analyzing your library...</span>
                <span class="block">Finding duplicate photos...</span>
            </p>
        </div>
    }
    else
    {
        <!-- Summary Stats -->
        <div class="report-stats-grid mb-3">
            <div class="report-stat-card">
                <div class="stat-label">Total Photos</div>
                <div class="stat-value text-blue-600">@totalImages.ToString("N0")</div>
                <div class="stat-sublabel">In your library</div>
            </div>
            <div class="report-stat-card">
                <div class="stat-label">Screenshots</div>
                <div class="stat-value text-yellow-600">@screenshotCount.ToString("N0")</div>
                <div class="stat-sublabel">Found</div>
            </div>
            <div class="report-stat-card">
                <div class="stat-label">Analyzed</div>
                <div class="stat-value text-green-600">@analyzedImages.ToString("N0")</div>
                <div class="stat-sublabel">Photos processed</div>
            </div>
            <div class="report-stat-card">
                <div class="stat-label">Duplicates</div>
                <div class="stat-value text-red-600">@duplicateCount.ToString("N0")</div>
                <div class="stat-sublabel">Files found</div>
            </div>
            <div class="report-stat-card">
                <div class="stat-label">Storage Used</div>
                <div class="stat-value text-cyan-600">@totalSizeStr</div>
                <div class="stat-sublabel">Total size</div>
            </div>
            <div class="report-stat-card">
                <div class="stat-label">Real Photos</div>
                <div class="stat-value text-green-600">@realPhotoCount.ToString("N0")</div>
                <div class="stat-sublabel">Personal photos</div>
            </div>
        </div>

        <!-- Photo Categories -->
        @if (categoryStats.Any())
        {
            <div class="bg-white rounded-lg shadow mb-4">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <h5 class="mb-0 font-semibold"><span class="oi oi-tag" aria-hidden="true"></span> Photo Categories</h5>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        @foreach (var category in categoryStats.OrderByDescending(c => c.Count))
                        {
                            <div class="mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h6 class="mb-0">@(category.Category == "photo" ? "üì∑ Photos" : category.Category == "screenshot" ? "üñ•Ô∏è Screenshots" : "‚ùì Other")</h6>
                                    <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded">@category.Count</span>
                                </div>
                                @{
                                    var percent = totalImages > 0 ? (double)category.Count / totalImages * 100 : 0;
                                    var progressColor = category.Category == "photo" ? "bg-success" : category.Category == "screenshot" ? "bg-warning" : "bg-secondary";
                                }
                                
                                <!-- Simple bar chart instead of progress bar -->
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold">@(category.Category == "photo" ? "üì∑ Photos" : category.Category == "screenshot" ? "üñ•Ô∏è Screenshots" : "‚ùì Other")</span>
                                    <span class="bg-blue-100 text-blue-800 text-lg font-medium px-2.5 py-0.5 rounded">@category.Count.ToString("N0")</span>
                                </div>
                                <div class="simple-bar-chart mb-3">
                                    <div class="bar-background">
                                        <div class="bar-fill @(category.Category == "photo" ? "bar-green" : category.Category == "screenshot" ? "bar-orange" : "bar-gray")" 
                                             style="width: @percent%;">
                                            <span class="bar-text">@percent.ToString("F1")%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }


        <!-- Screenshot Detection -->
        @if (categorizationStats != null && screenshotCount > 0)
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="oi oi-monitor" aria-hidden="true"></span> Screenshot Detection</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-warning">@categorizationStats.TotalScreenshots.ToString("N0")</h3>
                                <p class="text-muted mb-0">Screenshots found in your library</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            @{
                                var screenshotPercent = totalImages > 0 ? (double)screenshotCount / totalImages * 100 : 0;
                                var realPhotoPercent = 100 - screenshotPercent;
                            }
                            
                            <!-- Screenshots bar chart -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">üñ•Ô∏è Screenshots</span>
                                    <span class="badge bg-warning text-dark fs-6">@screenshotCount.ToString("N0")</span>
                                </div>
                                <div class="simple-bar-chart">
                                    <div class="bar-background">
                                        <div class="bar-fill bar-orange" style="width: @screenshotPercent%;">
                                            <span class="bar-text">@screenshotPercent.ToString("F1")%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Real photos bar chart -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">üì∑ Real Photos</span>
                                    <span class="badge bg-success fs-6">@realPhotoCount.ToString("N0")</span>
                                </div>
                                <div class="simple-bar-chart">
                                    <div class="bar-background">
                                        <div class="bar-fill bar-green" style="width: @realPhotoPercent%;">
                                            <span class="bar-text">@realPhotoPercent.ToString("F1")%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    @if (screenshotSamples.Any())
                    {
                        <hr>
                        <h6>Recent Screenshots</h6>
                        <div class="screenshots-grid">
                            @foreach (var sample in screenshotSamples.Take(6))
                            {
                                <div class="screenshot-item">
                                    <!-- Use ImageViewer with standard 200x200 thumbnails -->
                                    <ImageViewer Photo="sample" 
                                               ContainerClass="screenshot-thumbnail" 
                                               ShowTime="true"
                                               OnImageClick="EventCallback.Factory.Create<tbl_images>(this, (img) => ShowImageDetails(img.ImageId))">
                                        <AdditionalContent>
                                            <div class="card-body p-2">
                                                <small class="text-muted d-block text-truncate" title="@sample.FileName">
                                                    üñ•Ô∏è @sample.FileName
                                                </small>
                                            </div>
                                        </AdditionalContent>
                                    </ImageViewer>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }


        <!-- Recently Analyzed Photos -->
        @if (aiSamples.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="oi oi-image" aria-hidden="true"></span> Recently Analyzed Photos</h5>
                </div>
                <div class="card-body">
                    <div class="analyzed-photos-grid">
                        @foreach (var sample in aiSamples.Take(6))
                        {
                            <div class="analyzed-photo-item">
                                @{
                                    var sampleImage = CreateImageFromSample(sample);
                                }
                                <!-- Use ImageViewer with standard 200x200 thumbnails -->
                                <ImageViewer Photo="sampleImage" 
                                           ContainerClass="analyzed-thumbnail" 
                                           ShowTime="true"
                                           OnImageClick="EventCallback.Factory.Create<tbl_images>(this, (img) => ShowImageDetails(img.ImageId))">
                                    <AdditionalContent>
                                        <div class="card-body p-2">
                                            <h6 class="card-title text-truncate small" title="@sample.FileName">
                                                <span class="oi oi-file" aria-hidden="true"></span> @sample.FileName
                                            </h6>
                                            @if (!string.IsNullOrEmpty(sample.Description))
                                            {
                                                <p class="small text-muted mb-1">@(sample.Description.Length > 60 ? sample.Description.Substring(0, 60) + "..." : sample.Description)</p>
                                            }
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-info small">@(sample.Category == "photo" ? "üì∑ Photo" : sample.Category == "screenshot" ? "üñ•Ô∏è Screenshot" : "‚ùì Other")</span>
                                                @if (sample.AnalyzedAt.HasValue)
                                                {
                                                    <small class="text-muted">@sample.AnalyzedAt.Value.ToString("MMM dd")</small>
                                                }
                                            </div>
                                        </div>
                                    </AdditionalContent>
                                </ImageViewer>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (analyzedImages == 0)
        {
            <div class="alert alert-info" role="alert">
                <p class="mb-0"><span class="oi oi-info" aria-hidden="true"></span> No photos have been analyzed yet. Analysis helps categorize your photos automatically.</p>
            </div>
        }

        <!-- Duplicate Analysis -->
        @if (duplicateGroups.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <span class="oi oi-layers me-2 text-warning" aria-hidden="true"></span>
                        üîÑ Duplicate Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="duplicate-stats-grid mb-3">
                        <div class="duplicate-stat-item">
                            <div class="alert alert-warning text-center">
                                <h4>@duplicateGroups.Count</h4>
                                <small>Duplicate Groups</small>
                            </div>
                        </div>
                        <div class="duplicate-stat-item">
                            <div class="alert alert-danger text-center">
                                <h4>@duplicateCount</h4>
                                <small>Duplicate Files</small>
                            </div>
                        </div>
                        <div class="duplicate-stat-item">
                            <div class="alert alert-info text-center">
                                <h4>@FormatFileSize(duplicateGroups.Sum(g => g.FileSize * (g.Files.Count - 1)))</h4>
                                <small>Wasted Space</small>
                            </div>
                        </div>
                    </div>

                    <h6>Sample Duplicate Groups:</h6>
                    @{
                        int groupIndex = 0;
                    }
                    @foreach (var group in duplicateGroups.Take(5))
                    {
                        <div class="card mb-3 border-warning">
                            <div class="card-header bg-warning bg-opacity-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@group.Files.Count identical files</strong> - 
                                        Wasting @FormatFileSize(group.FileSize * (group.Files.Count - 1))
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="report-photos-grid mb-3">
                                    @foreach (var image in group.Files.Take(3))
                                    {
                                        <div class="report-image-container">
                                            <div class="position-relative">
                                                <ImageViewer Photo="image" ContainerClass="report-thumbnail" ShowTime="false" />
                                                <div class="position-absolute top-0 start-0 m-1" style="z-index: 10;">
                                                    <span class="badge bg-dark bg-opacity-75">@FormatFileSize(image.FileSizeBytes)</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="border-top pt-2">
                                    <h6 class="mb-2">File Locations:</h6>
                                    @foreach (var file in group.Files)
                                    {
                                        <div class="mb-1 small">
                                            <span class="oi oi-folder me-1" aria-hidden="true"></span>
                                            <strong>@(file.ScanDirectory?.DirectoryPath ?? "Unknown"):</strong>
                                            @file.RelativePath
                                            <span class="text-muted ms-2">(@file.DateCreated.ToString("yyyy-MM-dd"))</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        groupIndex++;
                    }
                    
                    @if (duplicateGroups.Count > 5)
                    {
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" @onclick="ShowAllDuplicates">
                                <span class="oi oi-layers me-2" aria-hidden="true"></span>
                                View All @duplicateGroups.Count Duplicate Groups
                            </button>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Scan Directories -->
        @if (scanDirectories.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <span class="oi oi-folder me-2" aria-hidden="true"></span>
                        üìÅ Scan Directories
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var dir in scanDirectories)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <span class="oi oi-folder-open me-2" aria-hidden="true"></span>
                                            @Path.GetFileName(dir.DirectoryPath)
                                        </h6>
                                        <p class="small text-muted mb-2">@dir.DirectoryPath</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-primary">@dir.ImageCount images</span>
                                            <small class="text-muted">Added @dir.DateCreated.ToString("MMM dd, yyyy")</small>
                                        </div>
                                        @if (dir.ImageCount > 0)
                                        {
                                            var dirPercent = totalImages > 0 ? (double)dir.ImageCount / totalImages * 100 : 0;
                                            <div class="progress mt-2" style="height: 0.5rem;">
                                                <div class="progress-bar bg-primary" 
                                                     role="progressbar"
                                                     style="width: @dirPercent%; border-radius: 0.25rem;"
                                                     title="@dirPercent.ToString("F1")% of total library">
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Photo Locations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="oi oi-map-marker me-2" aria-hidden="true"></span>
                    Photo Locations
                </h5>
            </div>
            <div class="card-body">
                @if (gpsEnabledImages == 0)
                {
                    <div class="text-center py-3">
                        <i class="oi oi-map-marker text-muted" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 text-muted">No Location Data Found</h6>
                        <p class="text-muted mb-0">Photos taken with smartphones usually include location information.</p>
                    </div>
                }
                else
                {
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success">@gpsEnabledImages.ToString("N0")</h3>
                                <p class="text-muted mb-0">Photos with locations</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-info">@uniqueLocations</h3>
                                <p class="text-muted mb-0">Different places</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6 class="text-muted">Location Data Coverage</h6>
                                <div class="display-6 text-success mb-2">@gpsPercentage.ToString("F1")%</div>
                                <p class="text-muted small mb-3">@gpsEnabledImages.ToString("N0") of @totalImages.ToString("N0") photos</p>
                                <div class="simple-bar-chart">
                                    <div class="bar-background">
                                        <div class="bar-fill bar-green" style="width: @gpsPercentage%;">
                                            <span class="bar-text">@gpsPercentage.ToString("F0")%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- File Type Distribution -->
        @if (fileTypeStats.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="oi oi-pie-chart" aria-hidden="true"></span> File Type Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="file-type-grid">
                        @foreach (var fileType in fileTypeStats.OrderByDescending(f => f.Count))
                        {
                            <div class="file-type-item">
                                <div class="text-center">
                                    <h6>@fileType.Extension.ToUpper()</h6>
                                    <h4 class="text-primary">@fileType.Count.ToString("N0")</h4>
                                    <small class="text-muted">@fileType.Percentage.ToString("F1")%</small>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Action Buttons -->
        <div class="flex justify-between mb-4">
            <button class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded" @onclick="GoBack">
                <span class="oi oi-arrow-left" aria-hidden="true"></span> Back to Home
            </button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded" @onclick="RefreshReport" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" role="status"></span>
                }
                <span class="oi oi-reload" aria-hidden="true"></span> Refresh Report
            </button>
        </div>
    }
</div>

<style>
    /* Report photos grid */
    .report-photos-grid {
        display: flex;
        gap: 1rem;
        justify-content: flex-start;
    }
    
    .report-image-container {
        flex: 1 1 33.33%;
        min-width: 0;
    }
    
    .report-thumbnail {
        width: 100%;
    }
    
    /* Screenshots grid */
    .screenshots-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .screenshot-item {
        flex: 0 0 150px;
    }
    
    .screenshot-thumbnail {
        width: 150px;
    }
    
    /* Analyzed photos grid */
    .analyzed-photos-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .analyzed-photo-item {
        flex: 0 0 150px;
    }
    
    .analyzed-thumbnail {
        width: 150px;
    }
    
    /* File type distribution grid */
    .file-type-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    
    .file-type-item {
        flex: 1 1 calc(25% - 1.125rem);
        min-width: 120px;
    }
    
    /* Duplicate stats grid */
    .duplicate-stats-grid {
        display: flex;
        gap: 1rem;
        flex-wrap: nowrap;
    }
    
    .duplicate-stat-item {
        flex: 1 1 33.33%;
        min-width: 0;
    }
    
    /* Summary stats grid */
    .report-stats-grid {
        display: flex;
        gap: 1rem;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 0.75rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .report-stat-card {
        flex: 1 1 16.66%;
        min-width: 0;
        text-align: center;
        padding: 0.5rem;
    }
    
    .report-stat-card .stat-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }
    
    .report-stat-card .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        line-height: 1.2;
    }
    
    .report-stat-card .stat-sublabel {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    /* On small screens, allow horizontal scrolling */
    @@media (max-width: 768px) {
        .report-stat-card {
            min-width: 100px;
        }
        .report-stat-card .stat-value {
            font-size: 1.25rem;
        }
    }
    
    /* Simple Bar Charts - No Bootstrap Progress Bars */
    .simple-bar-chart {
        width: 100%;
        margin: 0.5rem 0;
    }
    
    .bar-background {
        width: 100%;
        height: 40px;
        background-color: #e9ecef;
        border-radius: 20px;
        border: 2px solid #dee2e6;
        overflow: hidden;
        position: relative;
    }
    
    .bar-fill {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 18px;
        transition: width 0.8s ease;
        min-width: 60px; /* Always show at least some bar */
        position: relative;
    }
    
    .bar-text {
        font-weight: 700;
        font-size: 0.9rem;
        color: white;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        white-space: nowrap;
    }
    
    /* Color variants */
    .bar-green {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .bar-orange {
        background: linear-gradient(135deg, #fd7e14, #ffc107);
    }
    
    .bar-orange .bar-text {
        color: #000;
        text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
    }
    
    .bar-gray {
        background: linear-gradient(135deg, #6c757d, #adb5bd);
    }
    
    /* High quality image rendering for Report page */
    .photo-card .photo-thumbnail {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: optimizeQuality;
        backface-visibility: hidden;
        transform: translateZ(0);
        /* Ensure images don't scale beyond their native resolution */
        max-width: 200px;
        max-height: 200px;
        width: auto;
        height: auto;
    }
    
    /* Make sure containers don't force upscaling */
    .photo-container {
        max-width: 200px;
        max-height: 200px;
        margin: 0 auto;
    }
    
    /* Card improvements */
    .card {
        border: 1px solid #dee2e6;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
</style>

@code {
    private bool isLoading = true;
    private string errorMessage = "";
    
    // Summary stats
    private int totalImages = 0;
    private int analyzedImages = 0;
    private int percentAnalyzed = 0;
    private int duplicateCount = 0;
    private long totalSize = 0;
    private string totalSizeStr = "0 B";
    
    // Screenshot stats
    private int screenshotCount = 0;
    private int screenshotPercentage = 0;
    private int realPhotoCount = 0;
    private int realPhotoPercentage = 0;
    private ImageCategorizationResults? categorizationStats = null;
    private List<tbl_images> screenshotSamples = new();
    private Dictionary<int, string> thumbnailDataUris = new();
    
    // Category statistics
    private List<CategoryStat> categoryStats = new();
    
    // AI samples
    private List<AISample> aiSamples = new();
    private List<AISample> allAiSamples = new();
    private int currentAiPage = 0;
    private int aiSamplesPerPage = 6;
    
    // Duplicate groups
    private List<DuplicateGroup> duplicateGroups = new();
    
    // File type statistics
    private List<FileTypeStat> fileTypeStats = new();
    
    // Scan directories
    private List<ScanDirectoryStat> scanDirectories = new();
    
    // GPS/Location statistics
    private int gpsEnabledImages = 0;
    private int uniqueLocations = 0;
    private double gpsPercentage = 0;
    private List<FileTypeStat> gpsFileTypeStats = new();
    private List<GpsSampleImage> gpsSampleImages = new();

    private class CategoryStat
    {
        public string Category { get; set; } = "";
        public int Count { get; set; }
    }

    private class AISample
    {
        public int ImageId { get; set; }
        public string FileName { get; set; } = "";
        public string Category { get; set; } = "";
        public string Description { get; set; } = "";
        public string AIModel { get; set; } = "";
        public DateTime? AnalyzedAt { get; set; }
        public string JsonResponse { get; set; } = "";
        public string Keywords { get; set; } = "";
    }

    private class DuplicateGroup
    {
        public string Hash { get; set; } = "";
        public long FileSize { get; set; }
        public List<tbl_images> Files { get; set; } = new();
    }

    private class FileTypeStat
    {
        public string Extension { get; set; } = "";
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    private class ScanDirectoryStat
    {
        public string DirectoryPath { get; set; } = "";
        public int ImageCount { get; set; }
        public DateTime DateCreated { get; set; }
    }

    private class GpsSampleImage
    {
        public int ImageId { get; set; }
        public string FileName { get; set; } = "";
        public string FileExtension { get; set; } = "";
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public DateTime? DateTaken { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // IMMEDIATE FEEDBACK - SHOW LOADING RIGHT NOW!
        isLoading = true;
        errorMessage = "";
        StateHasChanged();
        
        try
        {
            // Ensure UI updates
            await Task.Delay(100);
            
            // Now load the data
            await LoadReportData();
        }
        catch (OperationCanceledException)
        {
            // Page navigation occurred, ignore
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during report initialization");
            errorMessage = $"Failed to load report: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadReportData()
    {
        try
        {
            isLoading = true;
            errorMessage = "";
            StateHasChanged();

            // Load basic statistics
            totalImages = await DbContext.tbl_images.CountAsync(i => i.IsDeleted == 0);
            
            // Load AI analysis statistics
            analyzedImages = await DbContext.tbl_image_analysis.CountAsync();
            percentAnalyzed = totalImages > 0 ? (analyzedImages * 100 / totalImages) : 0;
            
            // Load category statistics
            categoryStats = await DbContext.tbl_image_analysis
                .GroupBy(a => a.ImageCategory ?? "Unknown")
                .Select(g => new CategoryStat 
                { 
                    Category = g.Key, 
                    Count = g.Count() 
                })
                .ToListAsync();
            
            // Load categorization statistics
            categorizationStats = await FastImageCategorizationService.GetCategorizationStatisticsAsync();
            screenshotCount = categorizationStats?.TotalScreenshots ?? 0;
            screenshotPercentage = totalImages > 0 ? (int)Math.Round((double)screenshotCount * 100 / totalImages) : 0;
            realPhotoCount = totalImages - screenshotCount;
            realPhotoPercentage = totalImages > 0 ? (realPhotoCount * 100 / totalImages) : 0;
            
            // Load screenshot samples
            screenshotSamples = await DbContext.tbl_images
                .Join(DbContext.tbl_image_analysis,
                    img => img.ImageId,
                    analysis => analysis.ImageId,
                    (img, analysis) => new { Image = img, Analysis = analysis })
                .Where(x => x.Analysis.ImageCategory == "screenshot" && x.Image.IsDeleted == 0)
                .Select(x => x.Image)
                .Take(12)
                .ToListAsync();
            
            // Note: Screenshot thumbnails now handled by ImageViewer component
            
            // Load ALL AI analysis samples
            allAiSamples = await DbContext.tbl_image_analysis
                .Join(DbContext.tbl_images,
                    analysis => analysis.ImageId,
                    image => image.ImageId,
                    (analysis, image) => new AISample
                    {
                        ImageId = image.ImageId,
                        FileName = image.FileName,
                        Category = analysis.ImageCategory ?? "Unknown",
                        Description = analysis.AIDescription ?? "",
                        AIModel = analysis.AIModelUsed ?? "Unknown",
                        AnalyzedAt = analysis.AIAnalyzedAt,
                        JsonResponse = analysis.AIAnalysisJson ?? "",
                        Keywords = analysis.AIKeywords ?? ""
                    })
                .OrderByDescending(s => s.AnalyzedAt)
                .ToListAsync();
            
            // Set initial page of samples
            currentAiPage = 0;
            UpdateAiSamplesPage();
            
            // Load duplicate statistics with scan directory information
            var duplicates = await DbContext.tbl_images
                .Include(i => i.ScanDirectory)
                .Where(i => i.IsDeleted == 0 && !string.IsNullOrEmpty(i.FileHash))
                .GroupBy(i => i.FileHash)
                .Where(g => g.Count() > 1)
                .Select(g => new DuplicateGroup
                {
                    Hash = g.Key!,
                    FileSize = g.First().FileSizeBytes,
                    Files = g.ToList()
                })
                .ToListAsync();
            
            duplicateGroups = duplicates;
            duplicateCount = duplicates.Sum(g => g.Files.Count - 1); // Don't count the original
            
            // Calculate total size
            totalSize = await DbContext.tbl_images
                .Where(i => i.IsDeleted == 0)
                .SumAsync(i => (long)i.FileSizeBytes);
            totalSizeStr = FormatFileSize(totalSize);
            
            // Load scan directories statistics
            scanDirectories = await DbContext.tbl_scan_directory
                .Select(sd => new ScanDirectoryStat
                {
                    DirectoryPath = sd.DirectoryPath,
                    ImageCount = DbContext.tbl_images.Count(img => img.ScanDirectoryId == sd.ScanDirectoryId && img.IsDeleted == 0),
                    DateCreated = sd.DateCreated
                })
                .OrderBy(sd => sd.DateCreated)
                .ToListAsync();
            
            // Load file type statistics
            var extensions = await DbContext.tbl_images
                .Where(i => i.IsDeleted == 0 && !string.IsNullOrEmpty(i.FileName))
                .Select(i => Path.GetExtension(i.FileName).ToLower())
                .ToListAsync();
            
            fileTypeStats = extensions
                .GroupBy(ext => string.IsNullOrEmpty(ext) ? ".unknown" : ext)
                .Select(g => new FileTypeStat
                {
                    Extension = g.Key,
                    Count = g.Count(),
                    Percentage = totalImages > 0 ? (double)g.Count() / totalImages * 100 : 0
                })
                .OrderByDescending(f => f.Count)
                .ToList();
            
            // Load GPS/Location statistics
            var photosWithGps = await DbContext.tbl_images
                .Where(img => img.FileExists == 1 && img.IsDeleted == 0)
                .Join(DbContext.tbl_image_metadata.Where(m => m.Latitude.HasValue && m.Longitude.HasValue),
                      img => img.ImageId,
                      meta => meta.ImageId,
                      (img, meta) => new { Image = img, Metadata = meta })
                .ToListAsync();

            gpsEnabledImages = photosWithGps.Count;
            gpsPercentage = totalImages > 0 ? (double)gpsEnabledImages / totalImages * 100 : 0;

            // Count unique locations (rounded to ~100m precision)
            uniqueLocations = photosWithGps
                .GroupBy(x => new 
                { 
                    Lat = Math.Round(x.Metadata.Latitude!.Value, 3),
                    Lon = Math.Round(x.Metadata.Longitude!.Value, 3)
                })
                .Count();

            // GPS file type statistics
            if (photosWithGps.Any())
            {
                var gpsExtensions = photosWithGps
                    .Select(x => Path.GetExtension(x.Image.FileName).ToLower())
                    .ToList();

                gpsFileTypeStats = gpsExtensions
                    .GroupBy(ext => string.IsNullOrEmpty(ext) ? ".unknown" : ext)
                    .Select(g => new FileTypeStat
                    {
                        Extension = g.Key,
                        Count = g.Count(),
                        Percentage = gpsEnabledImages > 0 ? (double)g.Count() / gpsEnabledImages * 100 : 0
                    })
                    .OrderByDescending(f => f.Count)
                    .ToList();

                // Load sample GPS images - try to get different file types
                var distinctExtensions = gpsFileTypeStats.Take(4).Select(f => f.Extension).ToList();
                gpsSampleImages = new List<GpsSampleImage>();

                foreach (var extension in distinctExtensions)
                {
                    var sample = photosWithGps
                        .Where(x => Path.GetExtension(x.Image.FileName).ToLower() == extension)
                        .OrderByDescending(x => x.Metadata.DateTaken ?? x.Image.DateModified)
                        .Select(x => new GpsSampleImage
                        {
                            ImageId = x.Image.ImageId,
                            FileName = x.Image.FileName,
                            FileExtension = Path.GetExtension(x.Image.FileName),
                            Latitude = x.Metadata.Latitude!.Value,
                            Longitude = x.Metadata.Longitude!.Value,
                            DateTaken = x.Metadata.DateTaken
                        })
                        .FirstOrDefault();

                    if (sample != null)
                    {
                        gpsSampleImages.Add(sample);
                    }
                }

                // If we have fewer than 6 samples, fill with any remaining photos
                if (gpsSampleImages.Count < 6)
                {
                    var additionalSamples = photosWithGps
                        .Where(x => !gpsSampleImages.Any(s => s.ImageId == x.Image.ImageId))
                        .OrderByDescending(x => x.Metadata.DateTaken ?? x.Image.DateModified)
                        .Take(6 - gpsSampleImages.Count)
                        .Select(x => new GpsSampleImage
                        {
                            ImageId = x.Image.ImageId,
                            FileName = x.Image.FileName,
                            FileExtension = Path.GetExtension(x.Image.FileName),
                            Latitude = x.Metadata.Latitude!.Value,
                            Longitude = x.Metadata.Longitude!.Value,
                            DateTaken = x.Metadata.DateTaken
                        })
                        .ToList();

                    gpsSampleImages.AddRange(additionalSamples);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading report data");
            errorMessage = $"Failed to load report data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshReport()
    {
        // IMMEDIATE FEEDBACK!
        isLoading = true;
        errorMessage = "";
        StateHasChanged();
        
        await Task.Delay(100);
        await LoadReportData();
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void ShowAllDuplicates()
    {
        // TODO: Navigate to dedicated duplicates page
        // For now, show an alert
        // Navigation.NavigateTo("/duplicates");
    }

    private void UpdateAiSamplesPage()
    {
        aiSamples = allAiSamples
            .Skip(currentAiPage * aiSamplesPerPage)
            .Take(aiSamplesPerPage)
            .ToList();
    }

    private void NextAiPage()
    {
        if ((currentAiPage + 1) * aiSamplesPerPage < allAiSamples.Count)
        {
            currentAiPage++;
            UpdateAiSamplesPage();
            StateHasChanged();
        }
    }

    private void PreviousAiPage()
    {
        if (currentAiPage > 0)
        {
            currentAiPage--;
            UpdateAiSamplesPage();
            StateHasChanged();
        }
    }

    private void ShowImageDetails(int imageId)
    {
        ImageDetailsService.ShowImageDetails(imageId);
    }

    private string GetFormattedPercentage(int count, int total)
    {
        if (total == 0) return "0%";
        
        double percentage = (double)count * 100 / total;
        
        if (percentage < 0.1 && count > 0)
        {
            // For very small percentages, show more decimal places
            return $"{percentage:F2}%";
        }
        else if (percentage < 1.0 && count > 0)
        {
            // For small percentages, show one decimal place
            return $"{percentage:F1}%";
        }
        else
        {
            // For larger percentages, show whole numbers
            return $"{percentage:F0}%";
        }
    }
    
    private tbl_images CreateImageFromSample(AISample sample)
    {
        return new tbl_images
        {
            ImageId = sample.ImageId,
            FileName = sample.FileName,
            // Add other required properties as needed
            IsDeleted = 0,
            FileExists = 1
        };
    }
}